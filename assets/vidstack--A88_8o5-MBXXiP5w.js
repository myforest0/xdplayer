import{c as P,T as o,s as q,p as F,e as f,a as r,i as E,F as T,m as w,L as d,l as H,G as O,Q as $}from"./index-2yDd3r9W.js";import{R as C}from"./vidstack-Bio1UGiO-SvWZZn3K.js";import{E as R,t as I}from"./vidstack-a8Y1aEDS-FgnZ49Db.js";const V=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","playProgress","loadProgress","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"],v=class m extends R{constructor(){super(...arguments),this.$$PROVIDER_TYPE="VIMEO",this.scope=P(),this.Ga=0,this.Ha=new o(0,0),this.Ib=new o(0,0),this.F=null,this.H=null,this.sd=null,this.O=q(""),this.pc=q(!1),this.td=null,this.W=null,this.fh=null,this.Ea=new C(this.cd.bind(this)),this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF"}get c(){return this.b.delegate.c}get type(){return"vimeo"}get currentSrc(){return this.W}get videoId(){return this.O()}get hash(){return this.td}get isPro(){return this.pc()}preconnect(){const e=[this.fb(),"https://i.vimeocdn.com","https://f.vimeocdn.com","https://fresnel.vimeocdn.com"];for(const t of e)F(t,"preconnect")}setup(e){this.b=e,super.setup(e),f(this.ld.bind(this)),f(this.gh.bind(this)),f(this.hh.bind(this)),this.c("provider-setup",this)}destroy(){this.I(),this.q("destroy")}async play(){const{paused:e}=this.b.$state;if(r(e))return this.F||(this.F=I(()=>{if(this.F=null,e())return"Timed out."}),this.q("play")),this.F.promise}async pause(){const{paused:e}=this.b.$state;if(!r(e))return this.H||(this.H=I(()=>{if(this.H=null,!e())return"Timed out."}),this.q("pause")),this.H.promise}setMuted(e){this.q("setMuted",e)}setCurrentTime(e){this.q("seekTo",e)}setVolume(e){this.q("setVolume",e),this.q("setMuted",r(this.b.$state.muted))}setPlaybackRate(e){this.q("setPlaybackRate",e)}async loadSource(e){if(!E(e.src)){this.W=null,this.td=null,this.O.set("");return}const t=e.src.match(m.kd),s=t==null?void 0:t[1],i=t==null?void 0:t[2];this.O.set(s??""),this.td=i??null,this.W=e}ld(){this.I();const e=this.O();if(!e){this.db.set("");return}this.db.set(`${this.fb()}/video/${e}`)}gh(){const e=this.db(),t=this.O(),s=m.eh,i=s.get(t);if(!t)return;const n=T();if(this.sd=n,i){n.resolve(i);return}const a=`https://vimeo.com/api/oembed.json?url=${e}`,c=new AbortController;return window.fetch(a,{mode:"cors",signal:c.signal}).then(h=>h.json()).then(h=>{var k,y;const b=/vimeocdn.com\/video\/(.*)?_/,u=(y=(k=h==null?void 0:h.thumbnail_url)==null?void 0:k.match(b))==null?void 0:y[1],p=u?`https://i.vimeocdn.com/video/${u}_1920x1080.webp`:"",l={title:(h==null?void 0:h.title)??"",duration:(h==null?void 0:h.duration)??0,poster:p,pro:h.account_type!=="basic"};s.set(t,l),n.resolve(l)}).catch(h=>{n.reject(),this.c("error",{message:`Failed to fetch vimeo video info from \`${a}\`.`,code:1,error:w(h)})}),()=>{n.reject(),c.abort()}}hh(){const e=this.pc(),{$state:t,qualities:s}=this.b;if(t.canSetPlaybackRate.set(e),s[d.Nc](!e),e)return H(s,"change",()=>{var n;if(s.auto)return;const i=(n=s.selected)==null?void 0:n.id;i&&this.q("setQuality",i)})}fb(){return"https://player.vimeo.com"}Ue(){const{$iosControls:e}=this.b,{keyDisabled:t}=this.b.$props,{controls:s,playsinline:i}=this.b.$state,n=s()||e();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:n,h:this.hash,keyboard:n&&!t(),transparent:!0,playsinline:i(),dnt:!this.cookies}}cd(){this.q("getCurrentTime")}Fb(e,t){const{currentTime:s,paused:i,seeking:n,bufferedEnd:a}=this.b.$state;if(n()&&i()&&(this.q("getBuffered"),a()>e&&this.c("seeked",e,t)),s()===e)return;const c=s(),h={currentTime:e,played:this.Ga>=e?this.Ha:this.Ha=new o(0,this.Ga=e)};this.c("time-update",h,t),Math.abs(c-e)>1.5&&(this.c("seeking",e,t),!i()&&a()<e&&this.c("waiting",void 0,t))}cb(e,t){this.c("seeked",e,t)}nd(e){var s;const t=this.O();(s=this.sd)==null||s.promise.then(i=>{if(!i)return;const{title:n,poster:a,duration:c,pro:h}=i,{$iosControls:b}=this.b,{controls:u}=this.b.$state,p=u()||b();this.Ea.Cb(),this.pc.set(h),this.Ib=new o(0,c),this.c("poster-change",a,e),this.c("title-change",n,e),this.c("duration-change",c,e);const l={buffered:new o(0,0),seekable:this.Ib,duration:c};this.b.delegate.kc(l,e),p||this.q("_hideOverlay"),this.q("getQualities")}).catch(i=>{t===this.O()&&this.c("error",{message:"Failed to fetch oembed data",code:2,error:w(i)})})}ih(e,t,s){switch(e){case"getCurrentTime":this.Fb(t,s);break;case"getBuffered":O(t)&&t.length&&this.Ze(t[t.length-1][1],s);break;case"setMuted":this.bb(r(this.b.$state.volume),t,s);break;case"getChapters":break;case"getQualities":this.qc(t,s);break}}jh(){for(const e of V)this.q("addEventListener",e)}Ba(e){var t;this.c("pause",void 0,e),(t=this.H)==null||t.resolve(),this.H=null}yb(e){var t;this.c("play",void 0,e),(t=this.F)==null||t.resolve(),this.F=null}kh(e){const{paused:t}=this.b.$state;t()||this.c("playing",void 0,e)}Ze(e,t){const s={buffered:new o(0,e),seekable:this.Ib};this.c("progress",s,t)}lh(e){this.c("waiting",void 0,e)}mh(e){const{paused:t}=this.b.$state;t()||this.c("playing",void 0,e)}ed(e){const{paused:t}=this.b.$state;t()&&this.c("play",void 0,e),this.c("waiting",void 0,e)}bb(e,t,s){const i={volume:e,muted:t};this.c("volume-change",i,s)}qc(e,t){this.b.qualities[$._a]=e.some(s=>s.id==="auto")?()=>{this.q("setQuality","auto")}:void 0;for(const s of e){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[d.pa]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},t)}this.gb(e.find(s=>s.active),t)}gb({id:e}={},t){if(!e)return;const s=e==="auto",i=this.b.qualities.toArray().find(n=>n.id===e);s?(this.b.qualities[$.Za](s,t),this.b.qualities[d.qa](void 0,!0,t)):this.b.qualities[d.qa](i,!0,t)}nh(e,t,s){switch(e){case"ready":this.jh();break;case"loaded":this.nd(s);break;case"play":this.yb(s);break;case"playProgress":this.kh(s);break;case"pause":this.Ba(s);break;case"loadProgress":this.Ze(t.seconds,s);break;case"waiting":this.ed(s);break;case"bufferstart":this.lh(s);break;case"bufferend":this.mh(s);break;case"volumechange":this.bb(t.volume,r(this.b.$state.muted),s);break;case"durationchange":this.Ib=new o(0,t.duration),this.c("duration-change",t.duration,s);break;case"playbackratechange":this.c("rate-change",t.playbackRate,s);break;case"qualitychange":this.gb(t,s);break;case"fullscreenchange":this.c("fullscreen-change",t.fullscreen,s);break;case"enterpictureinpicture":this.c("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.c("picture-in-picture-change",!1,s);break;case"ended":this.c("end",void 0,s);break;case"error":this.V(t,s);break;case"seeked":this.cb(t.seconds,s);break}}V(e,t){var s;if(e.method==="play"){(s=this.F)==null||s.reject(e.message);return}}jd(e,t){e.event?this.nh(e.event,e.data,t):e.method&&this.ih(e.method,e.value,t)}mc(){}q(e,t){return this.hd({method:e,value:t})}I(){this.Ea.sa(),this.Ga=0,this.Ha=new o(0,0),this.Ib=new o(0,0),this.F=null,this.H=null,this.sd=null,this.fh=null,this.pc.set(!1)}};v.kd=/(?:https:\/\/)?(?:player\.)?vimeo(?:\.com)?\/(?:video\/)?(\d+)(?:\?hash=(.*))?/;v.eh=new Map;let Q=v;export{Q as VimeoProvider};
